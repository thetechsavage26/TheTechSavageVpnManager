#!/bin/bash
# --- TheTechSavage Multi-Login Killer ---

# Loop through all system users with UID >= 1000
awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd | while read user; do
    
    # 1. Check if user has a limit file
    if [[ -e "/etc/xray/limit/$user" ]]; then
        MAX_LOGIN=$(cat /etc/xray/limit/$user)
    else
        # Default limit if file is missing
        MAX_LOGIN=2
    fi

    # 2. Count Active SSH/Dropbear Connections
    # We count processes owned by the user that look like sshd or dropbear
    # (Using pgrep -u is cleaner than parsing 'who' for accurate connection counts)
    PID_COUNT=$(pgrep -u "$user" | grep -E "sshd|dropbear" | wc -l)
    
    # 3. Enforcement
    if [[ $PID_COUNT -gt $MAX_LOGIN ]]; then
        # Log the incident (optional)
        date +"%Y-%m-%d %H:%M:%S : Kicked $user ($PID_COUNT/$MAX_LOGIN logins)" >> /var/log/autokill.log
        
        # Kill the user's processes
        killall -u "$user"
        
        # Create a notification (optional, requires a notification script, usually skipped)
    fi
done
