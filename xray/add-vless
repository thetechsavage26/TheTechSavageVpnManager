#!/bin/bash
clear
CONFIG="/usr/local/etc/xray/config.json"
domain=$(cat /etc/xray/domain)

# --- COLORS & FORMATTING ---
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE}          ADD VLESS ACCOUNT               ${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# 1. GET USER INPUT (Loop until valid)
while true; do
    read -p " Username   : " user
    if [[ -z "$user" ]]; then
        echo -e "${RED}Error: Username cannot be empty!${NC}"
    elif grep -q "\"email\": \"$user\"" "$CONFIG"; then
        echo -e "${RED}Error: User '$user' already exists! Try another.${NC}"
    else
        # Valid and unique, break the loop
        break
    fi
done

read -p " Expired    : " masaaktif
if [[ -z "$masaaktif" ]]; then
    masaaktif=30 # Default to 30 days
fi

# Limit Logic (Hardcoded to 2)
limit=2

# 2. PROCESS DATA
uuid=$(cat /proc/sys/kernel/random/uuid)
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")
exp_display=$(date -d "$masaaktif days" +"%b %d, %Y")

# 3. INJECT USER (NEVERMORE LOGIC with #vl TAG)
sed -i '/\/\/ #vless$/a\// #vl '"$user $exp"'\
},{"id": "'""$uuid""'","email": "'""$user""'"' "$CONFIG"

# Set Limit File
mkdir -p /etc/xray/limit/vless
echo "$limit" > /etc/xray/limit/vless/$user

# Restart Xray
systemctl restart xray

# 4. GENERATE LINKS
vless_tls="vless://${uuid}@${domain}:443?path=/vless&security=tls&encryption=none&type=ws#${user}"
vless_none="vless://${uuid}@${domain}:80?path=/vless&encryption=none&type=ws#${user}"

# 5. SHOW OUTPUT
clear
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE}        VLESS ACCOUNT CREATED             ${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e " Remarks     : ${GREEN}${user}${NC}"
echo -e " Domain      : ${GREEN}${domain}${NC}"
echo -e " User ID     : ${GREEN}${uuid}${NC}"
echo -e " Expired On  : ${GREEN}${exp_display}${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE} LINK TLS    :${NC}"
echo -e "${GREEN}${vless_tls}${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE} LINK NO-TLS :${NC}"
echo -e "${GREEN}${vless_none}${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
read -n 1 -s -r -p "Press any key to back on menu"
menu-vless.sh
