#!/bin/bash
clear
CONFIG="/usr/local/etc/xray/config.json"
domain=$(cat /etc/xray/domain)

# --- COLORS & FORMATTING ---
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE}          ADD VMESS ACCOUNT               ${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# 1. GET USER INPUT (Loop until valid)
while true; do
    read -p " Username   : " user
    if [[ -z "$user" ]]; then
        echo -e "${RED}Error: Username cannot be empty!${NC}"
    elif grep -q "\"email\": \"$user\"" "$CONFIG"; then
        echo -e "${RED}Error: User '$user' already exists! Try another.${NC}"
    else
        # Valid and unique, break the loop
        break
    fi
done

read -p " Expired    : " masaaktif
if [[ -z "$masaaktif" ]]; then
    masaaktif=30 # Default to 30 days if empty
fi

# Limit Logic (Hardcoded to 2)
limit=2

# 2. PROCESS DATA
uuid=$(cat /proc/sys/kernel/random/uuid)
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")
exp_display=$(date -d "$masaaktif days" +"%b %d, %Y")

# 3. INJECT USER (NEVERMORE LOGIC)
sed -i '/\/\/ #vmess$/a\// ### '"$user $exp"'\
},{"id": "'""$uuid""'","alterId": 0,"email": "'""$user""'"' "$CONFIG"

# Set Limit File
mkdir -p /etc/xray/limit/vmess
echo "$limit" > /etc/xray/limit/vmess/$user

# Restart Xray
systemctl restart xray

# 4. GENERATE LINKS
json_tls='{"add":"'$domain'","aid":"0","host":"'$domain'","id":"'$uuid'","net":"ws","path":"/vmess","port":"443","ps":"'$user'","scy":"auto","sni":"'$domain'","tls":"tls","type":"","v":"2"}'
link_tls="vmess://$(echo $json_tls | base64 -w 0)"

json_none='{"add":"'$domain'","aid":"0","host":"'$domain'","id":"'$uuid'","net":"ws","path":"/vmess","port":"80","ps":"'$user'","scy":"auto","sni":"","tls":"none","type":"","v":"2"}'
link_none="vmess://$(echo $json_none | base64 -w 0)"

# 5. SHOW OUTPUT
clear
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE}        VMESS ACCOUNT CREATED             ${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e " Remarks     : ${GREEN}${user}${NC}"
echo -e " Domain      : ${GREEN}${domain}${NC}"
echo -e " User ID     : ${GREEN}${uuid}${NC}"
echo -e " Expired On  : ${GREEN}${exp_display}${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE} LINK TLS    :${NC}"
echo -e "${GREEN}${link_tls}${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${ORANGE} LINK NO-TLS :${NC}"
echo -e "${GREEN}${link_none}${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
read -n 1 -s -r -p "Press any key to back on menu"
menu-vmess.sh
